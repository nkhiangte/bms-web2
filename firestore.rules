rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // ---------------------------
    // Helper Functions
    // ---------------------------

    function isSignedIn() {
      return request.auth != null;
    }

    function hasRole(role) {
      return isSignedIn() &&
             exists(/databases/$(database)/documents/users/$(request.auth.uid)) &&
             get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role;
    }

    function isAdmin() {
      return hasRole('admin');
    }

    function isStaff() {
      return isSignedIn() &&
            (hasRole('admin') ||
             hasRole('user')  ||
             hasRole('warden'));
    }

    function isParent() {
      return hasRole('parent');
    }

    function isWardenOrAdmin() {
      return hasRole('admin') || hasRole('warden');
    }

    // Returns parent studentIds or [] when unavailable
    function getParentStudentIds() {
      return (
        !isSignedIn() || 
        !exists(/databases/$(database)/documents/users/$(request.auth.uid))
      )
      ? []
      : (
          get(/databases/$(database)/documents/users/$(request.auth.uid))
            .data.studentIds != null
          ? get(/databases/$(database)/documents/users/$(request.auth.uid))
              .data.studentIds
          : []
        );
    }

    function canAccessStudent(studentId) {
      return isStaff() ||
             (isParent() && studentId in getParentStudentIds());
    }
    
    function canAccessGrade(grade) {
      let studentIds = getParentStudentIds();
      // This is a simplified check. It assumes a parent might have access
      // if they have a child in any class. A more complex rule might check
      // if any of their children are in the specified grade. For now, this is
      // a basic guard.
      return isStaff() || (isParent() && studentIds.size() > 0);
    }

    // ---------------------------
    // Online Admissions
    // ---------------------------
    match /online_admissions/{admissionId} {
      allow create: if true; // Public can submit forms
      allow get: if true;    // FIX: Public can retrieve their specific record via Ref ID
      allow list, delete: if isAdmin();
      // FIX: Allow public to update (for payment step) if the application is not rejected.
      allow update: if isAdmin() || (resource.data.status != 'rejected');
    }
    
    // ---------------------------
    // User Profiles
    // ---------------------------
    match /users/{userId} {
      allow create: if isSignedIn() && request.auth.uid == userId;
      allow get, update: if (isSignedIn() && request.auth.uid == userId) || isAdmin();
      allow read, list, delete: if isAdmin();

      match /prefs/{prefId} {
        allow read, write: if isSignedIn() && request.auth.uid == userId;
      }
    }

    // ---------------------------
    // Public Website Data
    // ---------------------------
    match /news/{newsId} {
      allow read, list: if true;
      allow create, update, delete: if isAdmin();
    }

    // Config collection (Fees, GradeDefs, Sitemap, SchoolDetails)
    match /config/{configDoc} {
      allow read: if true; // Public read required for website and settings
      allow write: if isStaff();
    }

    match /staff/{docId} {
      allow read, list: if true;
      allow create, update, delete: if isStaff();
    }

    match /calendarEvents/{docId} {
      allow read, list: if true;
      allow create, update, delete: if isStaff();
    }

    // ---------------------------
    // Routines (Class & Exam)
    // ---------------------------
    match /examRoutines/{docId} {
      allow read, list: if true;
      allow create, update, delete: if isStaff();
    }

    match /classRoutines/{docId} {
      allow read, list: if true;
      allow create, update, delete: if isStaff();
    }

    // ---------------------------
    // Settings & Config
    // ---------------------------
    match /settings/academic {
      allow read: if true; 
      allow write: if isAdmin();
    }

    // ---------------------------
    // Student Records
    // ---------------------------
    match /students/{studentId} {
      allow list: if isStaff();
      allow get: if canAccessStudent(studentId);
      allow create, update, delete: if isStaff();
    }

    // ---------------------------
    // TC Records
    // ---------------------------
    match /tcRecords/{docId} {
      allow read, list, write, delete: if isStaff();
    }

    // ---------------------------
    // Service Certificates
    // ---------------------------
    match /serviceCertificates/{docId} {
      allow read, list, write, delete: if isStaff();
    }

    // ---------------------------
    // Conduct Logs
    // ---------------------------
    match /conductLog/{docId} {
      allow list: if isStaff() || isParent();
      allow get: if isStaff() || (isParent() && resource.data.studentId in getParentStudentIds());
      allow create, update, delete: if isStaff();
    }

    // ---------------------------
    // Attendance
    // ---------------------------
    match /studentAttendance/{docId} {
      allow read: if isStaff() || isParent();
      allow write, delete: if isStaff();
    }

    match /staffAttendance/{docId} {
      allow read, write, delete: if isStaff();
    }

    // ---------------------------
    // Homework, Syllabus, Messages, Notices
    // ---------------------------
    match /homework/{homeworkId} {
      allow list: if isStaff() || isParent();
      allow get: if isStaff() || (isParent() && canAccessGrade(resource.data.grade));
      allow create, update, delete: if isStaff();
    }
    
    match /syllabus/{syllabusId} {
      allow read, list: if true;
      allow create, update, delete: if isStaff();
    }
    
    match /parentMessages/{messageId} {
      allow create: if isParent();
      allow read, list: if isStaff() || (isParent() && request.auth.uid == resource.data.fromParentId);
      allow update, delete: if isStaff();
    }
    
    match /notices/{noticeId} {
      allow read, list: if isStaff() || isParent();
      allow create, update, delete: if isStaff();
    }


    // ---------------------------
    // Inventory System
    // ---------------------------
    match /inventory/{docId} {
      allow read, write, delete: if isStaff();
    }

    // ---------------------------
    // Hostel Management
    // ---------------------------
    match /hostelResidents/{docId} {
      allow read, list, write, delete: if isWardenOrAdmin();
    }

    match /hostelStaff/{docId} {
      allow read, list, write, delete: if isWardenOrAdmin();
    }

    match /hostelInventory/{docId} {
      allow read, list, write, delete: if isWardenOrAdmin();
    }

    match /stockLogs/{docId} {
      allow read, write, delete: if isWardenOrAdmin();
    }

    match /choreRoster/{docId} {
      allow read, write, delete: if isWardenOrAdmin();
    }

    match /hostelDisciplineLog/{docId} {
      allow list: if isWardenOrAdmin() || isParent();
      allow get: if isWardenOrAdmin() ||
                 (isParent() && resource.data.studentId in getParentStudentIds());
      allow create, update, delete: if isWardenOrAdmin();
    }
    
    // ---------------------------
    // Archives (Dynamic Collections)
    // ---------------------------
    match /{archiveCollection}/{document=**} {
       allow read, write: if isAdmin() && archiveCollection.matches('^archive_.*');
    }

    // ---------------------------
    // Fallback Rule (Deny everything else)
    // ---------------------------
    match /{document=**} {
      allow read, write: if false;
    }
  }
}